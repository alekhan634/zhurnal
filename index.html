<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –ø–æ –≤—Å–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞–º –∏ —É—á–µ–Ω–∏–∫–∞–º</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin:0; padding:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .tab-buttons {
    display: flex;
    background-color: #2c3e50;
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  }
  .tab-buttons button {
    flex: 1;
    padding: 14px 0;
    border: none;
    background: transparent;
    color: #ecf0f1;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
    border-bottom: 3px solid transparent;
  }
  .tab-buttons button:hover {
    background-color: #34495e;
  }
  .tab-buttons button.active {
    border-bottom: 3px solid #e67e22;
    color: #e67e22;
    background-color: #34495e;
  }
  .tab {
    display: none;
    max-width: 960px;
    margin: 20px auto 40px;
    background: white;
    padding: 25px 30px;
    border-radius: 10px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  }
  .tab.active-tab {
    display: block;
  }
  h3 {
    margin-top: 0;
    color: #2c3e50;
    font-weight: 700;
  }
  button.action-btn {
    background-color: #e67e22;
    border: none;
    color: white;
    padding: 12px 20px;
    margin: 8px 8px 8px 0;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
    user-select: none;
  }
  button.action-btn:hover {
    background-color: #d35400;
  }
  input[type="text"], input[type="number"], input[type="file"] {
    padding: 10px 12px;
    margin: 8px 12px 16px 0;
    border: 1.8px solid #ccc;
    border-radius: 6px;
    font-size: 1rem;
    width: 220px;
    transition: border-color 0.3s;
  }
  input[type="text"]:focus, input[type="number"]:focus, input[type="file"]:focus {
    border-color: #e67e22;
    outline: none;
  }
  label {
    font-weight: 600;
    margin-right: 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 0.95rem;
  }
  th, td {
    padding: 10px 12px;
    border: 1px solid #ddd;
    text-align: left;
  }
  th {
    background-color: #e67e22;
    color: white;
    font-weight: 700;
  }
  tr:nth-child(even) {
    background-color: #f9f9f9;
  }
  tr:hover {
    background-color: #ffe6cc;
  }
  .table-btn {
    background: #3498db;
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    margin-right: 6px;
    transition: background-color 0.3s;
  }
  .table-btn:hover {
    background: #2980b9;
  }
  .table-btn.delete {
    background: #e74c3c;
  }
  .table-btn.delete:hover {
    background: #c0392b;
  }
  #help p, #about p {
    line-height: 1.5;
    font-size: 1rem;
  }
  #about img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 15px;
  }
  .chart-container {
    margin-top: 30px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    background: #fff;
  }
  canvas {
    max-width: 100%;
    height: 300px !important;
  }
  @media (max-width: 700px) {
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      margin-bottom: 12px;
    }
    .tab-buttons button {
      font-size: 0.9rem;
      padding: 10px 0;
    }
  }
</style>
</head>
<body>

<div class="tab-buttons" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º">
  <button class="active" onclick="showTab('upload')" role="tab" aria-selected="true" aria-controls="upload" id="tab-upload">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫</button>
  <button onclick="showTab('journal')" role="tab" aria-selected="false" aria-controls="journal" id="tab-journal">–ñ—É—Ä–Ω–∞–ª</button>
  <button onclick="showTab('stats')" role="tab" aria-selected="false" aria-controls="stats" id="tab-stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  <button onclick="showTab('charts')" role="tab" aria-selected="false" aria-controls="charts" id="tab-charts">–ì—Ä–∞—Ñ–∏–∫–∏</button>
  <button onclick="showTab('help')" role="tab" aria-selected="false" aria-controls="help" id="tab-help">–ü–æ–º–æ—â—å</button>
  <button onclick="showTab('about')" role="tab" aria-selected="false" aria-controls="about" id="tab-about">–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div id="upload" class="tab active-tab" role="tabpanel" aria-labelledby="tab-upload">
  <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞</h3>
  <p>–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: <code>–§–ò–û,–ö–ª–∞—Å—Å,–ü—Ä–µ–¥–º–µ—Ç,–û—Ü–µ–Ω–∫–∞</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω,9–ê,–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞,5)</p>
  <input type="file" id="fileInput" accept=".csv,.txt" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ü–µ–Ω–æ–∫ (.csv, .txt)" />
  <div id="uploadTable" aria-live="polite" style="margin-top: 20px;"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ -->
<div id="journal" class="tab" role="tabpanel" aria-labelledby="tab-journal">
  <h3>–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞</h3>
  <div>
    <input type="text" id="fio" placeholder="–§–ò–û —É—á–µ–Ω–∏–∫–∞" aria-label="–§–ò–û —É—á–µ–Ω–∏–∫–∞" />
    <input type="text" id="className" placeholder="–ö–ª–∞—Å—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 9–ê)" aria-label="–ö–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞" />
    <input type="text" id="subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)" aria-label="–ü—Ä–µ–¥–º–µ—Ç" />
    <input type="number" id="grade" placeholder="–û—Ü–µ–Ω–∫–∞ (1-5)" min="1" max="5" aria-label="–û—Ü–µ–Ω–∫–∞ —É—á–µ–Ω–∏–∫–∞" />
    <button class="action-btn" onclick="addOrUpdateStudent()">–î–æ–±–∞–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="action-btn" onclick="saveJournal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
  </div>
  <div>
    <label for="filterClass">–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∞—Å—Å—É:</label>
    <select id="filterClass" onchange="renderJournalTable()">
      <option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
    </select>

    <label for="filterSubject">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É:</label>
    <select id="filterSubject" onchange="renderJournalTable()">
      <option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
    </select>
  </div>
  <div id="journalTable" aria-live="polite" style="margin-top: 20px;"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
<div id="stats" class="tab" role="tabpanel" aria-labelledby="tab-stats">
  <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º –≤–∏–¥–µ</h3>
  <div>
    <label for="statsClass">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:</label>
    <select id="statsClass" onchange="renderStats()">
      <option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
    </select>

    <label for="statsSubject">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:</label>
    <select id="statsSubject" onchange="renderStats()">
      <option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>
    </select>
  </div>
  <div id="statsOutput" aria-live="polite" style="margin-top: 15px;"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<div id="charts" class="tab" role="tabpanel" aria-labelledby="tab-charts">
  <h3>–ì—Ä–∞—Ñ–∏–∫–∏ –ø–æ –≤—Å–µ–º –ø—Ä–µ–¥–º–µ—Ç–∞–º –∏ —É—á–µ–Ω–∏–∫–∞–º</h3>
  <div id="chartsContainer" style="margin-top:20px;"></div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–º–æ—â—å -->
<div id="help" class="tab" role="tabpanel" aria-labelledby="tab-help">
  <h3>–ü–æ–º–æ—â—å</h3>
  <p><strong>–í—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –ø–æ—á—Ç—É:</strong> alekhan@gmail.com</p>
  <p><strong>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫:</strong> –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ü–µ–Ω–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∞ CSV –∏–ª–∏ TXT. –§–æ—Ä–º–∞—Ç –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏: <code>–§–ò–û,–ö–ª–∞—Å—Å,–ü—Ä–µ–¥–º–µ—Ç,–û—Ü–µ–Ω–∫–∞</code>. –û—Ü–µ–Ω–∫–∞ - —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5.</p>
  <p><strong>–ñ—É—Ä–Ω–∞–ª:</strong> –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —É—á–µ–Ω–∏–∫–æ–≤. –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∂—É—Ä–Ω–∞–ª.</p>
  <p><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong> –í—ã–≤–æ–¥–∏—Ç —Å–≤–æ–¥–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –ø–æ–¥—Å—á—ë—Ç–æ–º —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏, –º–µ–¥–∏–∞–Ω—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –æ—Ü–µ–Ω–æ–∫ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–ª–∞—Å—Å—É –∏ –ø—Ä–µ–¥–º–µ—Ç—É –∏–ª–∏ –ø–æ –≤—Å–µ–º.</p>
  <p><strong>–ì—Ä–∞—Ñ–∏–∫–∏:</strong> –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–∏ –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞.</p>
  <p><strong>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ:</strong> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–µ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã.</p>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ -->
<div id="about" class="tab" role="tabpanel" aria-labelledby="tab-about">
  <h3>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h3>
  <img src="https://cdn.promodj.com/afs/4f675099712b583994da2c9fe5782c7c12%3Aresize%3A2000x2000%3Asame%3Ab3b350" alt="–§–æ—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞" />
  <p><strong>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:</strong> –ê.–í.–ì—Ä–µ—á–∏—à–Ω–∏–∫–æ–≤</p>
  <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã:</strong> alekhan@gmail.com</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let students = [];
  let editIndex = -1;
  let chartInstances = [];

  function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');

    document.querySelectorAll('.tab-buttons button').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-selected', 'false');
    });
    const activeBtn = document.querySelector(`.tab-buttons button[onclick="showTab('${tabId}')"]`);
    if(activeBtn) {
      activeBtn.classList.add('active');
      activeBtn.setAttribute('aria-selected', 'true');
      activeBtn.focus();
    }

    if(tabId === 'stats') renderStats();
    if(tabId === 'charts') renderAllSubjectCharts();
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const data = [];
    for(let line of lines) {
      const parts = line.split(',');
      if(parts.length >= 4) {
        const fio = parts[0].trim();
        const className = parts[1].trim();
        const subject = parts[2].trim();
        const grade = parseInt(parts[3].trim());
        if(fio && className && subject && !isNaN(grade) && grade >= 1 && grade <= 5) {
          data.push({fio, className, subject, grade});
        }
      }
    }
    return data;
  }

  document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if(!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    if(!['csv','txt'].includes(ext)) {
      alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .csv –∏ .txt');
      e.target.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const data = parseCSV(evt.target.result);
        if(data.length === 0) {
          alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.');
          return;
        }
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–ø–∏—Å–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –§–ò–û, –∫–ª–∞—Å—Å–æ–º –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–º, –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Ü–µ–Ω–∫—É
        students = [];
        data.forEach(rec => {
          const existing = students.find(s => s.fio === rec.fio && s.className === rec.className && s.subject === rec.subject);
          if(existing) {
            existing.grade = rec.grade;
          } else {
            students.push({...rec});
          }
        });
        editIndex = -1;
        updateFilters();
        renderUploadTable();
        renderJournalTable();
        alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
      } catch {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞.');
      }
    };
    reader.readAsText(file);
  });

  function updateFilters() {
    const classes = Array.from(new Set(students.map(s => s.className))).sort();
    const subjects = Array.from(new Set(students.map(s => s.subject))).sort();

    ['filterClass','statsClass'].forEach(id => {
      const select = document.getElementById(id);
      if(!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="all">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>';
      classes.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        select.appendChild(opt);
      });
      if(classes.includes(currentValue)) select.value = currentValue;
    });

    ['filterSubject','statsSubject'].forEach(id => {
      const select = document.getElementById(id);
      if(!select) return;
      const currentValue = select.value;
      select.innerHTML = '<option value="all">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>';
      subjects.forEach(subj => {
        const opt = document.createElement('option');
        opt.value = subj;
        opt.textContent = subj;
        select.appendChild(opt);
      });
      if(subjects.includes(currentValue)) select.value = currentValue;
    });
  }

  function renderUploadTable() {
    if(students.length === 0) {
      document.getElementById('uploadTable').innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>';
      return;
    }
    let html = `<table aria-label="–¢–∞–±–ª–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫"><thead><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th></tr></thead><tbody>`;
    for(let s of students) {
      html += `<tr><td>${escapeHTML(s.fio)}</td><td>${escapeHTML(s.className)}</td><td>${escapeHTML(s.subject)}</td><td>${s.grade}</td></tr>`;
    }
    html += '</tbody></table>';
    document.getElementById('uploadTable').innerHTML = html;
  }

  function renderJournalTable() {
    const filterClass = document.getElementById('filterClass').value;
    const filterSubject = document.getElementById('filterSubject').value;

    let filtered = students;
    if(filterClass !== 'all') filtered = filtered.filter(s => s.className === filterClass);
    if(filterSubject !== 'all') filtered = filtered.filter(s => s.subject === filterSubject);

    if(filtered.length === 0) {
      document.getElementById('journalTable').innerHTML = '<p>–ó–∞–ø–∏—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
      return;
    }

    let html = `<table aria-label="–¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ü–µ–Ω–æ–∫"><thead><tr><th>–§–ò–û</th><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;
    filtered.forEach((s) => {
      const realIndex = students.indexOf(s);
      html += `<tr>
        <td>${escapeHTML(s.fio)}</td>
        <td>${escapeHTML(s.className)}</td>
        <td>${escapeHTML(s.subject)}</td>
        <td>${s.grade}</td>
        <td>
          <button class="table-btn" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${escapeHTML(s.fio)}" onclick="editStudent(${realIndex})">‚úé</button>
          <button class="table-btn delete" aria-label="–£–¥–∞–ª–∏—Ç—å ${escapeHTML(s.fio)}" onclick="deleteStudent(${realIndex})">üóë</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('journalTable').innerHTML = html;
  }

  function addOrUpdateStudent() {
    const fioInput = document.getElementById('fio');
    const classInput = document.getElementById('className');
    const subjectInput = document.getElementById('subject');
    const gradeInput = document.getElementById('grade');

    const fio = fioInput.value.trim();
    const className = classInput.value.trim();
    const subject = subjectInput.value.trim();
    const grade = parseInt(gradeInput.value);

    if(fio.length < 3) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –§–ò–û (–Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤).');
      fioInput.focus();
      return;
    }
    if(className.length < 1) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª–∞—Å—Å —É—á–µ–Ω–∏–∫–∞.');
      classInput.focus();
      return;
    }
    if(subject.length < 1) {
      alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.');
      subjectInput.focus();
      return;
    }
    if(isNaN(grade) || grade < 1 || grade > 5) {
      alert('–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º –æ—Ç 1 –¥–æ 5.');
      gradeInput.focus();
      return;
    }

    if(editIndex >= 0) {
      students[editIndex] = {fio, className, subject, grade};
      editIndex = -1;
    } else {
      students.push({fio, className, subject, grade});
    }

    fioInput.value = '';
    classInput.value = '';
    subjectInput.value = '';
    gradeInput.value = '';

    updateFilters();
    renderJournalTable();
    renderUploadTable();
    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  }

  function editStudent(index) {
    if(index < 0 || index >= students.length) return;
    editIndex = index;
    const student = students[index];
    document.getElementById('fio').value = student.fio;
    document.getElementById('className').value = student.className;
    document.getElementById('subject').value = student.subject;
    document.getElementById('grade').value = student.grade;
    showTab('journal');
    document.getElementById('fio').focus();
  }

  function deleteStudent(index) {
    if(index < 0 || index >= students.length) return;
    if(confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —É—á–µ–Ω–∏–∫–∞ "${students[index].fio}"?`)) {
      students.splice(index, 1);
      if(editIndex === index) editIndex = -1;
      updateFilters();
      renderJournalTable();
      renderUploadTable();
      alert('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞.');
    }
  }

  function saveJournal() {
    if(students.length === 0) {
      alert('–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç, –Ω–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å.');
      return;
    }
    const lines = students.map(s =>
      `"${s.fio.replace(/"/g, '""')}","${s.className.replace(/"/g, '""')}","${s.subject.replace(/"/g, '""')}",${s.grade}`
    );
    const csvContent = lines.join('\n');
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'journal.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function escapeHTML(text) {
    return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function renderStats() {
    const filterClass = document.getElementById('statsClass').value;
    const filterSubject = document.getElementById('statsSubject').value;

    let filtered = students;
    if(filterClass !== 'all') filtered = filtered.filter(s => s.className === filterClass);
    if(filterSubject !== 'all') filtered = filtered.filter(s => s.subject === filterSubject);

    if(filtered.length === 0) {
      document.getElementById('statsOutput').innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</p>';
      return;
    }

    const grades = filtered.map(s => s.grade).sort((a,b) => a-b);
    const avg = (grades.reduce((a,b) => a+b, 0) / grades.length).toFixed(2);

    let median;
    const mid = Math.floor(grades.length / 2);
    if(grades.length % 2 === 0) {
      median = ((grades[mid -1] + grades[mid]) / 2).toFixed(2);
    } else {
      median = grades[mid].toFixed(2);
    }

    const counts = {};
    for(let i=1; i<=5; i++) counts[i] = 0;
    grades.forEach(g => { counts[g]++; });
    const total = grades.length;

    let html = `<table aria-label="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫">
      <thead><tr><th>–û—Ü–µ–Ω–∫–∞</th><th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th><th>–ü—Ä–æ—Ü–µ–Ω—Ç</th></tr></thead><tbody>`;
    for(let i=1; i<=5; i++) {
      const percent = ((counts[i]/total)*100).toFixed(1);
      html += `<tr><td>${i}</td><td>${counts[i]}</td><td>${percent}%</td></tr>`;
    }
    html += `</tbody></table>`;

    html += `<p><strong>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞:</strong> ${avg}</p>`;
    html += `<p><strong>–ú–µ–¥–∏–∞–Ω–∞:</strong> ${median}</p>`;

    document.getElementById('statsOutput').innerHTML = html;
  }

  // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É –æ—Ç–¥–µ–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –≤—Å–µ–º —É—á–µ–Ω–∏–∫–∞–º (–∫–ª–∞—Å—Å + –§–ò–û) –∏ —Å—Ä–µ–¥–Ω–µ–π –æ—Ü–µ–Ω–∫–æ–π
  function renderAllSubjectCharts() {
    const container = document.getElementById('chartsContainer');
    container.innerHTML = '';
    chartInstances.forEach(c => c.destroy());
    chartInstances = [];

    if(students.length === 0) {
      container.innerHTML = '<p>–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤.</p>';
      return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    const subjects = Array.from(new Set(students.map(s => s.subject))).sort();

    subjects.forEach((subject, idx) => {
      // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
      const filtered = students.filter(s => s.subject === subject);

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —É—á–µ–Ω–∏–∫—É (–§–ò–û + –∫–ª–∞—Å—Å), —Å—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –æ—Ü–µ–Ω–∫—É –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
      const studentMap = {};
      filtered.forEach(s => {
        const key = s.className + ' - ' + s.fio;
        if(!studentMap[key]) studentMap[key] = [];
        studentMap[key].push(s.grade);
      });

      const labels = [];
      const averages = [];
      for(const key in studentMap) {
        labels.push(key);
        const grades = studentMap[key];
        const avg = grades.reduce((a,b) => a+b, 0) / grades.length;
        averages.push(+avg.toFixed(2));
      }

      // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ canvas
      const chartDiv = document.createElement('div');
      chartDiv.className = 'chart-container';

      const title = document.createElement('h4');
      title.textContent = `–ü—Ä–µ–¥–º–µ—Ç: ${subject}`;
      chartDiv.appendChild(title);

      const canvas = document.createElement('canvas');
      canvas.id = 'chartCanvas' + idx;
      chartDiv.appendChild(canvas);

      container.appendChild(chartDiv);

      const ctx = canvas.getContext('2d');

      const data = {
        labels: labels,
        datasets: [{
          label: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞',
          data: averages,
          backgroundColor: '#3498db',
          borderColor: '#2980b9',
          borderWidth: 1
        }]
      };

      const options = {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            max: 5,
            ticks: { stepSize: 1 }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: {
            callbacks: {
              label: ctx => `–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${ctx.parsed.y}`
            }
          }
        }
      };

      const chart = new Chart(ctx, {
        type: 'bar',
        data,
        options
      });

      chartInstances.push(chart);
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  showTab('upload');
</script>

</body>
</html>
